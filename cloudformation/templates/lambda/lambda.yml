AWSTemplateFormatVersion: 2010-09-09
Description: Lambda for GitLabRepositoryInspector

Parameters:
  SystemName:
    Type: String
    AllowedPattern: '[a-z0-9-]*'
  EnvType:
    Type: String
  gitlabchangelogsImageTag:
    Type: String
  LambdaMemorySize:
    Type: Number

Mappings:
  AzMap:
    ap-northeast-1:
      1st: ap-northeast-1a
      2nd: ap-northeast-1c
      3rd: ap-northeast-1d

Resources:
  LambdaGitLabRepositoryInspector:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub ${SystemName}-${EnvType}-lambda-gitlab-repository-inspector
      Description: !Sub ${SystemName}-${EnvType}-lambda-gitlab-repository-inspector
      PackageType: Image
      Code:
        ImageUri: !Sub ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/gitlabchangelogs:${gitlabchangelogsImageTag}
      Architectures:
        - x86_64
      MemorySize: !Ref LambdaMemorySize
      Timeout: 900
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/${SystemName}-${EnvType}-role-lambda-gitlab-repository-inspector
      Environment:
        Variables:
          SYSTEM_NAME: !Ref SystemName
          ENV_TYPE: !Ref EnvType
      Tags:
        - Key: Name
          Value: !Sub ${SystemName}-${EnvType}-lambda-gitlab-repository-inspector
        - Key: SystemName
          Value: !Ref SystemName
        - Key: EnvType
          Value: !Ref EnvType
